**[中文版](https://github.com/chengyuZou/OpenSim-Skin-Attachment/blob/main/README-zh.md)**
**[请移动至最新版](https://github.com/chengyuZou/OpenSim-Skin-Attachment/tree/main/new)**

# OpenSim-Skin-Attachment

now(unfinished)
![OpenSim 4 5 2025_3_23 22_32_55](https://github.com/user-attachments/assets/eeefac02-0446-45c3-962a-0388f0c68571)

```python
@Article{Pagnon_2022_JOSS, 
  AUTHOR = {Pagnon, David and Domalain, Mathieu and Reveret, Lionel}, 
  TITLE = {Pose2Sim: An open-source Python package for multiview markerless kinematics}, 
  JOURNAL = {Journal of Open Source Software}, 
  YEAR = {2022},
  DOI = {10.21105/joss.04362}, 
  URL = {https://joss.theoj.org/papers/10.21105/joss.04362}
}
```
The provided main file is a skin model in STL format.

Important: Any <Body> tag containing the name "skin" must have its <mesh_file> modified; otherwise, it will cause errors or prevent the skin model from displaying properly.

## 1. Introduction
OpenSim is a free and open-source software developed by Stanford University for developing, analyzing, and visualizing human musculoskeletal systems. It has broad applications in fields such as gait dynamics analysis, sports performance research, surgical procedure simulation, and medical device design. In OpenSim, a musculoskeletal model consists of multiple bones connected by joints, with muscles attached to the bones. These muscles generate forces to drive joint motion. Currently, OpenSim is utilized by hundreds of biomechanics laboratories worldwide for movement research and is supported by an active developer community that continuously improves its functionality.

However, the default models generated by OpenSim do not include skin, requiring users to manually add it.

##2. Example (Body) Section
The file used to compile the OpenSim skeletal model is in .osim format, which is written in XML, analogous to the way HTML is used in front-end development.

[https://github.com/user-attachments/assets/82bca19b-c789-4b60-931b-3766588aa9c3](https://github.com/user-attachments/assets/82bca19b-c789-4b60-931b-3766588aa9c3)

Taking the Code for Defining the Right Upper Arm Bone Model as an Example:

```xml
<Body name="humerus_r">
    <!--The geometry used to display the axes of this Frame.-->
    <FrameGeometry name="frame_geometry">
        <!--Path to a Component that satisfies the Socket 'frame' of type Frame.-->
        <socket_frame>..</socket_frame>
        <!--Scale factors in X, Y, Z directions respectively.-->
        <scale_factors>0.20000000000000001 0.20000000000000001 0.20000000000000001</scale_factors>
    </FrameGeometry>
    <!--List of geometry attached to this Frame. Note, the geometry are treated as fixed to the frame and they share the transform of the frame when visualized-->
    <attached_geometry>
        <Mesh name="humerus_r_geom_1">
            <!--Path to a Component that satisfies the Socket 'frame' of type Frame.-->
            <socket_frame>..</socket_frame>
            <!--Scale factors in X, Y, Z directions respectively.-->
            <scale_factors>1.0124521312654093 1.0124521312654093 1.0124521312654093</scale_factors>
            <!--Default appearance attributes for this Geometry-->
            <Appearance>
                <!--Flag indicating whether the associated Geometry is visible or hidden.-->
                <visible>true</visible>
                <!--The opacity used to display the geometry between 0:transparent, 1:opaque.-->
                <opacity>1</opacity>
                <!--The color, (red, green, blue), [0, 1], used to display the geometry. -->
                <color>1 1 1</color>
                <!--Visuals applied to surfaces associated with this Appearance.-->
                <SurfaceProperties>
                    <!--The representation (1:Points, 2:Wire, 3:Shaded) used to display the object.-->
                    <representation>3</representation>
                </SurfaceProperties>
            </Appearance>
            <!--Name of geometry file.-->
            <mesh_file>humerus_rv.vtp</mesh_file>
        </Mesh>
    </attached_geometry>
    <!--Set of wrap objects fixed to this body that GeometryPaths can wrap over.This property used to be a member of Body but was moved up with the introduction of Frames.-->
    <WrapObjectSet name="wrapobjectset">
        <objects />
        <groups />
    </WrapObjectSet>
    <!--The mass of the body (kg)-->
    <mass>1.6941896825604743</mass>
    <!--The location (Vec3) of the mass center in the body frame.-->
    <mass_center>0 -0.16655040049742237 0</mass_center>
    <!--The elements of the inertia tensor (Vec6) as [Ixx Iyy Izz Ixy Ixz Iyz] measured about the mass_center and not the body origin.-->
    <inertia>0.010207114500963559 0.0035211383608296349 0.011457157068761123 0 0 0</inertia>
</Body>
```

### 2.1 The Upper Arm Model is Defined Using the <Body> Tag.
### 2.2 <FrameGeometry> Visualizes the Coordinate Axes.
<scale_factors> Specifies the Scaling Factors for the Axes.

<socket_frame> Inherits Parent Coordinate System Transformations (can be ignored).

### 2.3 <attached_geometry> Visualizes Geometry.
<Mesh> Loads the 3D Mesh Model.

<socket_frame> Indicates That This Component Inherits the Parent Frame's Coordinate System.

<scale_factors> Defines Scaling Factors Along the XYZ Axes, Where 1 1 1 Represents the Original Size.

#### 2.3.1 <Appearance> Defines Visual Properties.
<visible> Specifies Whether the Model is Visible.

<opacity> Controls Model Transparency, Where 1 is Fully Opaque.

<color> Defines the RGB Color (Range: 0-1), with 1 1 1 Representing White.

<representation> Specifies the Rendering Mode (Can Be Ignored).

#### 2.3.2 <mesh_file> Specifies the File Path for the Model.

### 2.4 <WrapObjectSet> Defines Dynamic Interaction Components.
This is usually not critical and often involves adding objects such as spheres or ellipsoids, so it can be skipped.

### 2.5 Remaining Components
<mass> Defines the Mass.

<mass_center> Specifies the Center of Mass in Local Coordinates.

<inertia> Defines the Inertia Tensor (Ixx, Iyy, Izz, Ixy, Ixz, Iyz).

## 3. Demonstration (Body) Section

```xml
<!-- Right Upper Arm Skin Model -->
<Body name="skin_humerus_r">
    <mass>1.6941896825604743</mass>
    <!--The location (Vec3) of the mass center in the body frame.-->
    <mass_center>0 0 0</mass_center>
    <!--The elements of the inertia tensor (Vec6) as [Ixx Iyy Izz Ixy Ixz Iyz] measured about the mass_center and not the body origin.-->
    <inertia>0.010207114500963559 0.0035211383608296349 0.01 0 0 0</inertia>
    <Position>0  0  0</Position>
    <FrameGeometry name="frame_geometry">
        <!--Path to a Component that satisfies the Socket 'frame' of type Frame.-->
        <socket_frame>..</socket_frame>
        <!--Scale factors in X, Y, Z directions respectively.-->
        <scale_factors>0.30000000000000001 0.30000000000000001 0.30000000000000001</scale_factors>
    </FrameGeometry>
    
    <attached_geometry>
        <Mesh name="skin_humerus_right">
            <!--Path to a Component that satisfies the Socket 'frame' of type Frame.-->
            <socket_frame>..</socket_frame>
            <!--Scale factors in X, Y, Z directions respectively.-->
            <scale_factors>1.0124521312654093 1.0124521312654093 1.0124521312654093</scale_factors>
            <!--Default appearance attributes for this Geometry-->
            <Appearance>
                <!--Flag indicating whether the associated Geometry is visible or hidden.-->
                <visible>true</visible>
                <!--The opacity used to display the geometry between 0:transparent, 1:opaque.-->
                <opacity>1</opacity>
                <!--The color, (red, green, blue), [0, 1], used to display the geometry. -->
                <color>1 1 1</color>
                <!--Visuals applied to surfaces associated with this Appearance.-->
                <SurfaceProperties>
                    <!--The representation (1:Points, 2:Wire, 3:Shaded) used to display the object.-->
                    <representation>3</representation>
                </SurfaceProperties>
            </Appearance>
            <!--Name of geometry file.-->
            <mesh_file>D:\GaitCode\pose2sim-main\Pose2Sim\Demo_SinglePerson\parts\back-arm.stl</mesh_file>
        </Mesh>
    </attached_geometry>
</Body>
```
The <mesh_file> defines the file path for an upper arm skin model in .STL format, which looks like this in Blender:

[https://github.com/user-attachments/assets/2ba2b4bc-d8a1-4cb7-8081-202eada038d2](https://github.com/user-attachments/assets/2ba2b4bc-d8a1-4cb7-8081-202eada038d2)

Important: It is essential to set the center point as the centroid of the model; otherwise, the skin model cannot be properly attached in the final step.

## 4. Demonstration (Joint) Section
After defining the Body section, the next step is to define the Joint section. Without this, importing the file into OpenSim will result in errors.

```xml
<!-- Weld Joint for Right Upper Arm Skin Attachment -->
<WeldJoint name="humerus_r_skin_attachment">
    <socket_parent_frame>humerus_r_offset</socket_parent_frame>
    <socket_child_frame>humerus_r_skin_frame</socket_child_frame>

    <frames>
        <PhysicalOffsetFrame name="humerus_r_offset">
            <FrameGeometry name="frame_geometry">
                <socket_frame>...</socket_frame>
                <scale_factors>0.2 0.2 0.2</scale_factors>
            </FrameGeometry>
            <socket_parent>/bodyset/humerus_r</socket_parent>
            <translation>0 -0.15655040049742237 0</translation>
            <orientation>0 0 0</orientation>
        </PhysicalOffsetFrame>

        <PhysicalOffsetFrame name="humerus_r_skin_frame">
            <FrameGeometry name="frame_geometry">
                <socket_frame>...</socket_frame>
                <scale_factors>1 1 1</scale_factors>
            </FrameGeometry>
            <socket_parent>/bodyset/skin_humerus_r</socket_parent>
            <translation>0 0 0</translation>
            <orientation>0 0 0</orientation>
        </PhysicalOffsetFrame>
    </frames>
</WeldJoint>
```

A WeldJoint is defined here to rigidly attach the right upper arm skin (skin_humerus_r) to the corresponding skeletal structure (humerus_r). The weld joint completely eliminates any relative motion between the two rigid bodies, which exactly meets our expectations for skin attachment.

### 4.1 Joint Configuration
The <socket_parent_frame> defines the offset coordinate system of the parent bone

The <socket_child_frame> defines the coordinate system of the child skin component

At this stage, two physical offset coordinate systems are present and must be defined below

### 4.2 <frames> Section
This section defines the coordinate systems on both the bone side and the skin side.

#### 4.2.1 <PhysicalOffsetFrame name="humerus_r_offset">
<socket_parent> specifies the parent component (the right upper arm bone)

<translation> defines the position in the X, Y, and Z axes; here it indicates an offset of approximately 0.157 meters in the negative Y-direction within the bone's local coordinate system

<orientation> defines the rotation, which in this case is set to no rotation

#### 4.2.2 <PhysicalOffsetFrame name="humerus_r_skin_frame">
This frame is almost identical to the previous one, where <socket_parent> designates the right upper arm skin. It is fully aligned with the original coordinate system of the skin component.

The final outcome is that when the bone (humerus_r) moves, the weld joint forces the humerus_r_offset and humerus_r_skin_frame to coincide, thereby driving the skin component (skin_humerus_r) to follow the bone's motion.

## 5. Demonstration (Visualization)

![image](https://github.com/user-attachments/assets/21f227cf-bbf7-4c4c-9c30-def094c584af)

https://github.com/user-attachments/assets/f68a5c74-fbbd-40e3-8eb6-f6828acebcc4




